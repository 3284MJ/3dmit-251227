<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mitsuhashi-kun WebApp V1.1.0</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f8ff; font-family: 'Segoe UI', sans-serif; }
        
        /* UI: Developer Log */
        #log-container {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 260px;
            background: rgba(0, 0, 0, 0.6);
            color: #00ffcc;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            user-select: none;
            z-index: 100;
        }

        /* UI: Help Modal */
        #help-modal {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            max-width: 220px;
            font-size: 13px;
            z-index: 100;
        }
        h3 { margin: 0 0 8px 0; color: #ffd700; font-size: 16px; border-bottom: 1px solid #555; }
        ul { padding-left: 18px; margin: 0; }
        li { margin-bottom: 5px; }
        .highlight { color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>

    <div id="log-container">
        <div><strong>MITSUHASHI_SYS_LOG V1.1.0</strong></div>
        <div id="status">Status: IDLE</div>
        <div id="coords">Pos: (0.0, 0.0)</div>
    </div>

    <div id="help-modal">
        <h3>How to Play</h3>
        <ul>
            <li><span class="highlight">1 Tap:</span> トコトコ移動</li>
            <li><span class="highlight">Double Tap:</span> 爆速BOOST</li>
        </ul>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.166.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Core Settings ---
        const CONFIG = {
            moveSpeed: 0.1,
            boostSpeed: 0.35,
            colors: {
                body: 0xffd700,
                eye: 0x111111,
                cheek: 0xffa07a,
                limb: 0xffcc00
            }
        };

        let scene, camera, renderer, mitsuhashi;
        let targetPos = new THREE.Vector3(0, 0, 0);
        let isMoving = false;
        let isBoosting = false;
        let lastTap = 0;
        const particles = [];

        const elStatus = document.getElementById('status');
        const elCoords = document.getElementById('coords');

        init();
        animate();

        function init() {
            // Scene & Camera
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f8ff);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 12, 15);
            camera.lookAt(0, 0, 0);

            // Lights
            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 0.5);
            sun.position.set(5, 10, 7);
            scene.add(sun);

            // Invisible Floor for Raycasting
            const floorGeo = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshBasicMaterial({ visible: false });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.name = "floor";
            scene.add(floor);

            // Character Construction
            createMitsuhashi();

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Events
            window.addEventListener('pointerdown', onPointerDown);
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function createMitsuhashi() {
            mitsuhashi = new THREE.Group();

            // Body
            const body = new THREE.Mesh(
                new THREE.SphereGeometry(1, 32, 32),
                new THREE.MeshStandardMaterial({ color: CONFIG.colors.body })
            );
            body.position.y = 1;
            mitsuhashi.add(body);

            // Eyes
            const eyeGeo = new THREE.SphereGeometry(0.12, 16, 16);
            const eyeMat = new THREE.MeshBasicMaterial({ color: CONFIG.colors.eye });
            const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
            eyeL.position.set(-0.35, 1.2, 0.85);
            const eyeR = eyeL.clone();
            eyeR.position.x = 0.35;
            mitsuhashi.add(eyeL, eyeR);

            // Cheeks
            const cheek = new THREE.Mesh(
                new THREE.CircleGeometry(0.15, 16),
                new THREE.MeshBasicMaterial({ color: CONFIG.colors.cheek, transparent: true, opacity: 0.7 })
            );
            cheek.position.set(0.6, 1.0, 0.85);
            cheek.rotation.y = 0.4;
            const cheekL = cheek.clone();
            cheekL.position.x = -0.6;
            cheekL.rotation.y = -0.4;
            mitsuhashi.add(cheek, cheekL);

            // Limbs (The "Mitsuhashi" signature)
            const limbGeo = new THREE.SphereGeometry(0.2, 16, 16);
            const limbMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.limb });
            
            const footL = new THREE.Mesh(limbGeo, limbMat);
            footL.position.set(-0.5, 0.2, 0);
            footL.scale.set(1, 0.7, 1.3);
            const footR = footL.clone();
            footR.position.x = 0.5;
            
            const handL = new THREE.Mesh(limbGeo, limbMat);
            handL.position.set(-0.9, 0.8, 0.2);
            const handR = handL.clone();
            handR.position.x = 0.9;

            mitsuhashi.add(footL, footR, handL, handR);

            // Simple Shadow
            const shadow = new THREE.Mesh(
                new THREE.CircleGeometry(0.8, 32),
                new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.15 })
            );
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.y = 0.01;
            mitsuhashi.add(shadow);

            scene.add(mitsuhashi);
        }

        function onPointerDown(e) {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2(
                (e.clientX / window.innerWidth) * 2 - 1,
                -(e.clientY / window.innerHeight) * 2 + 1
            );
            raycaster.setFromCamera(mouse, camera);
            const intersect = raycaster.intersectObjects(scene.children).find(i => i.object.name === "floor");

            if (intersect) {
                const now = Date.now();
                if (now - lastTap < 300) {
                    isBoosting = true;
                    // Boost: オーバーランさせるために目標を延長
                    const dir = new THREE.Vector3().subVectors(intersect.point, mitsuhashi.position).normalize();
                    targetPos.copy(intersect.point).add(dir.multiplyScalar(5));
                    elStatus.textContent = "Status: BOOST!!";
                } else {
                    isBoosting = false;
                    targetPos.copy(intersect.point);
                    elStatus.textContent = "Status: WALKING";
                }
                isMoving = true;
                lastTap = now;
            }
        }

        function createSmoke() {
            const smoke = new THREE.Mesh(
                new THREE.SphereGeometry(0.2, 8, 8),
                new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 })
            );
            smoke.position.copy(mitsuhashi.position);
            smoke.position.y = 0.3;
            scene.add(smoke);
            particles.push({ mesh: smoke, life: 1.0 });
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isMoving) {
                const dist = mitsuhashi.position.distanceTo(targetPos);
                if (dist > 0.2) {
                    const step = isBoosting ? CONFIG.boostSpeed : CONFIG.moveSpeed;
                    const dir = new THREE.Vector3().subVectors(targetPos, mitsuhashi.position).normalize();
                    
                    mitsuhashi.position.add(dir.multiplyScalar(step));
                    mitsuhashi.lookAt(targetPos.x, 0, targetPos.z);
                    
                    // Animation: Wobble
                    mitsuhashi.position.y = 0 + Math.abs(Math.sin(Date.now() * (isBoosting ? 0.02 : 0.01))) * 0.4;
                    
                    if (isBoosting && Math.random() > 0.5) createSmoke();
                } else {
                    isMoving = false;
                    isBoosting = false;
                    mitsuhashi.position.y = 0;
                    elStatus.textContent = "Status: IDLE";
                }
            }

            // Update Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.life -= 0.04;
                p.mesh.scale.multiplyScalar(0.96);
                p.mesh.material.opacity = p.life;
                if (p.life <= 0) {
                    scene.remove(p.mesh);
                    particles.splice(i, 1);
                }
            }

            elCoords.textContent = `Pos: (${mitsuhashi.position.x.toFixed(1)}, ${mitsuhashi.position.z.toFixed(1)})`;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

