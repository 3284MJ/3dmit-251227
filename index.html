<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DMIT - Mitsuhashi Debug Build</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; touch-action: none; font-family: sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        .ui-panel {
            position: absolute; left: 10px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 8px 12px; font-family: monospace; font-size: 12px;
            border-radius: 4px; z-index: 100;
            backdrop-filter: blur(2px);
        }
        #debug-log { top: 10px; pointer-events: none; }
        #help-btn { top: 45px; cursor: pointer; pointer-events: auto; }

        /* „Éá„Éê„ÉÉ„Ç∞„É°„Éã„É•„ÉºÔºàÂàùÊúü„ÅØÈùûË°®Á§∫Ôºâ */
        #debug-toggle-btn {
            display: none; position: absolute; right: 10px; top: 10px;
            background: #ff4757; color: white; padding: 10px;
            border-radius: 5px; cursor: pointer; z-index: 3000; font-weight: bold;
        }
        #debug-sliders {
            display: none; position: absolute; right: 10px; top: 60px;
            background: rgba(0,0,0,0.8); color: white; padding: 15px;
            border-radius: 8px; z-index: 3000; width: 200px;
        }
        .slider-group { margin-bottom: 15px; }
        .slider-group label { display: block; font-size: 10px; margin-bottom: 5px; }
        .slider-group input { width: 100%; }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal-card {
            background: white; width: 85%; max-width: 320px;
            padding: 20px; border-radius: 15px; display: flex; flex-direction: column; gap: 10px;
        }
        .help-list-item { background: #f8f9fa; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #555; border: 1px solid #eee; }
        .detail-view { display: none; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-close { background: #666; color: white; }
    </style>
</head>
<body>
    <div id="debug-log" class="ui-panel">Status: Ready.</div>
    <div id="help-btn" class="ui-panel" onclick="openHelpMenu()">üí° Êìç‰ΩúË™¨Êòé</div>

    <div id="debug-toggle-btn" onclick="toggleSliders()">üîß Debug Settings</div>
    <div id="debug-sliders">
        <div class="slider-group">
            <label>Stiffness (Á°¨„Åï): <span id="val-stiff">0.20</span></label>
            <input type="range" id="input-stiff" min="0.01" max="0.5" step="0.01" value="0.2">
        </div>
        <div class="slider-group">
            <label>Damping (Ê∏õË°∞): <span id="val-damp">0.70</span></label>
            <input type="range" id="input-damp" min="0.1" max="0.99" step="0.01" value="0.7">
        </div>
        <div style="font-size: 9px; color: #aaa;">‚Äª„Çπ„É©„Ç§„ÉÄ„Éº„ÇíÂãï„Åã„Åó„Å¶„Äå„Å∑„Çã„Å∑„ÇãÊÑü„Äç„ÇíÁ¢∫Ë™ç„ÄÇ„Éô„Çπ„Éà„Å™Êï∞ÂÄ§„Çí„É°„É¢„Åó„Å¶„Å≠ÔºÅ</div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-card">
            <div id="menu-list"></div>
            <div id="detail-area" class="detail-view">
                <div id="detail-content"></div>
                <div class="btn-group"><button class="btn btn-close" onclick="closeModal()">Èñâ„Åò„Çã</button></div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.166.1/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.166.1/examples/jsm/"
            }
        }
    </script>
    
    <script>
        // --- UI Logic ---
        const helpContent = [
            { title: "ÁßªÂãï", icon: "üëÜ", desc: "Âú∞Èù¢„Çí„Çø„ÉÉ„Éó/„ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„ÅßÁßªÂãï„ÄÇ" },
            { title: "Èö†„ÅóÊ©üËÉΩ", icon: "üïµÔ∏è", desc: "„Éü„ÉÑ„Éè„Ç∑„Åè„Çì‰ª•Â§ñ„ÅÆÂ†¥ÊâÄ„Çí„Äê10ÁßíÈñìÈï∑Êäº„Åó„Äë„Åô„Çã„Å®„ÄÅÂè≥‰∏ä„Å´„Ç®„É≥„Ç∏„Éã„Ç¢Â∞ÇÁî®„ÅÆË™øÊï¥„É°„Éã„É•„Éº„ÅåÂá∫Áèæ„Åó„Åæ„Åô„ÄÇ" }
        ];

        window.openHelpMenu = function() { window.isModalOpen = true; document.getElementById('help-modal').style.display = 'flex'; showList(); };
        window.closeModal = function() { window.isModalOpen = false; document.getElementById('help-modal').style.display = 'none'; };
        window.showList = function() {
            const listEl = document.getElementById('menu-list');
            listEl.innerHTML = helpContent.map((item, i) => `<div class="help-list-item" onclick="showDetail(${i})">${item.title}</div>`).join('');
            document.getElementById('detail-area').style.display = 'none';
            listEl.style.display = 'block';
        };
        window.showDetail = function(i) {
            document.getElementById('menu-list').style.display = 'none';
            document.getElementById('detail-area').style.display = 'block';
            document.getElementById('detail-content').innerHTML = `<div style="text-align:center; font-size:30px;">${helpContent[i].icon}</div><p>${helpContent[i].desc}</p>`;
        };

        let debugVisible = false;
        window.toggleSliders = function() {
            debugVisible = !debugVisible;
            document.getElementById('debug-sliders').style.display = debugVisible ? 'block' : 'none';
        };
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const logElement = document.getElementById('debug-log');
        function debugLog(msg) { logElement.innerText = "Status: " + msg; }

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 2.0));
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshBasicMaterial({ visible: false }));
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        let model, mixer, flag, blobShadow;
        let actions = {}, activeAction = null;
        
        // --- ÂºæÂäõ„Éë„É©„É°„Éº„Çø„Å®„Çπ„É©„Ç§„ÉÄ„ÉºÈÄ£Âãï ---
        let springParams = { stiffness: 0.2, damping: 0.7 };
        const stInput = document.getElementById('input-stiff');
        const daInput = document.getElementById('input-damp');
        stInput.oninput = (e) => { springParams.stiffness = parseFloat(e.target.value); document.getElementById('val-stiff').innerText = e.target.value; };
        daInput.oninput = (e) => { springParams.damping = parseFloat(e.target.value); document.getElementById('val-damp').innerText = e.target.value; };

        const targetScale = new THREE.Vector3(1, 1, 1);
        const currentScale = new THREE.Vector3(1, 1, 1);
        const springVelocity = new THREE.Vector3(0, 0, 0);

        let isProcessing = false, tapTimer = null;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const controls = new OrbitControls(camera, renderer.domElement);

        // --- 10ÁßíÈï∑Êäº„ÅóÊ§úÁü•„É≠„Ç∏„ÉÉ„ÇØ ---
        let holdTimer = null;
        function onTouchStart(e) {
            // „Éü„ÉÑ„Éè„Ç∑„Åè„ÇìÊú¨‰Ωì„Çí„Çø„ÉÉ„Éó„Åó„Åü„ÅãÂà§ÂÆö
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            
            const intersectsModel = model ? raycaster.intersectObject(model, true) : [];
            
            // „É¢„Éá„É´‰ª•Â§ñ„Çí„Çø„ÉÉ„Éó„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Åø„Çø„Ç§„Éû„ÉºÈñãÂßã
            if (intersectsModel.length === 0) {
                holdTimer = setTimeout(() => {
                    document.getElementById('debug-toggle-btn').style.display = 'block';
                    debugLog("DEBUG MODE UNLOCKED!");
                }, 10000); // 10Áßí
            }
        }
        function onTouchEnd() { clearTimeout(holdTimer); }
        window.addEventListener('mousedown', onTouchStart);
        window.addEventListener('mouseup', onTouchEnd);
        window.addEventListener('touchstart', onTouchStart);
        window.addEventListener('touchend', onTouchEnd);

        // --- ÁßªÂãïÂá¶ÁêÜ (ÂâçÂõû„Ç≥„Éº„ÉâÁ∂ôÊâø) ---
        window.addEventListener('click', handleInput);
        function handleInput(e) {
            if (window.isModalOpen || e.target.closest('.ui-panel') || e.target.closest('#debug-sliders') || e.target.closest('#debug-toggle-btn')) return;
            // ... (ÂâçÂõû„Å®ÂêåÊßò„ÅÆRaycast„Å®Navigation„É≠„Ç∏„ÉÉ„ÇØ) ...
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(ground);
            if (intersects.length > 0) {
                const point = intersects[0].point.clone();
                if (!tapTimer) {
                    tapTimer = setTimeout(() => { tapTimer = null; startNavigation(point, false); }, 250);
                } else {
                    clearTimeout(tapTimer); tapTimer = null; startNavigation(point, true);
                }
            }
        }

        async function startNavigation(pos, boost) {
            isProcessing = true;
            debugLog(boost ? "BOOST!" : "Walking...");
            const run = actions['Ëµ∞Ë°å'] || Object.values(actions)[0];
            if (activeAction) activeAction.fadeOut(0.2);
            run.reset().fadeIn(0.2).play(); activeAction = run;

            // Âá∫Áô∫Ë∏è„ÇìÂºµ„Çä
            targetScale.set(1.2, 0.7, 1.2);
            await new Promise(r => setTimeout(r, 200));
            targetScale.set(0.9, 1.1, 0.9);

            const startPos = model.position.clone();
            const dist = model.position.distanceTo(pos);
            const duration = boost ? dist * 100 : dist * 200;
            const startTime = performance.now();

            await new Promise(res => {
                function move() {
                    const elapsed = performance.now() - startTime;
                    const p = Math.min(elapsed / duration, 1);
                    model.position.lerpVectors(startPos, pos, p);
                    model.lookAt(pos.x, model.position.y, pos.z);
                    if (p < 1) requestAnimationFrame(move); else res();
                }
                move();
            });

            // Âà∞ÁùÄ„Å∑„Çã„ÇìÔºÅ
            targetScale.set(1.4, 0.6, 1.4);
            await new Promise(r => setTimeout(r, 150));
            targetScale.set(1, 1, 1);
            
            if (activeAction) activeAction.fadeOut(0.5);
            isProcessing = false;
            debugLog("Ready.");
        }

        // --- Main Loop ---
        new GLTFLoader().load('./model.glb', (gltf) => {
            model = gltf.scene; scene.add(model);
            mixer = new THREE.AnimationMixer(model);
            gltf.animations.forEach(a => actions[a.name] = mixer.clipAction(a));
        });

        function animate() {
            requestAnimationFrame(animate);
            if (mixer) mixer.update(1/60);
            if (model) {
                // „Çπ„Éó„É™„É≥„Ç∞Ë®àÁÆóÔºà„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÂÄ§„Çí‰ΩøÁî®Ôºâ
                springVelocity.x += (targetScale.x - currentScale.x) * springParams.stiffness;
                springVelocity.y += (targetScale.y - currentScale.y) * springParams.stiffness;
                springVelocity.z += (targetScale.z - currentScale.z) * springParams.stiffness;
                springVelocity.multiplyScalar(springParams.damping);
                currentScale.add(springVelocity);
                model.scale.copy(currentScale);
            }
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
