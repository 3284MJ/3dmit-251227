<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DMIT_WebApp V.1.2.0 - Debug Mode</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }

        /* 開発者ログ UI */
        #dev-log {
            position: absolute; top: 10px; left: 10px;
            width: 260px; height: 140px;
            background: rgba(0, 0, 0, 0.75); color: #00ffcc;
            padding: 10px; font-size: 11px; font-family: 'Courier New', monospace;
            border-radius: 4px; border: 1px solid #00ffcc;
            pointer-events: none; line-height: 1.4;
        }

        /* デバッグパネル (右上) */
        #debug-panel {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255, 0, 0, 0.2); color: #ffeb3b;
            padding: 10px; font-size: 12px; border: 1px solid #ffeb3b;
            pointer-events: none; text-align: right;
        }

        /* 操作説明モーダル */
        #inst-modal {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); color: white;
            padding: 15px 25px; border-radius: 12px;
            text-align: center; border-left: 5px solid #00ffcc;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

<div id="dev-log">
    [SYSTEM] V.1.2.0 DEBUG_INIT...<br>
    [MODEL] Loading model.glb...<br>
    [STATUS] Standby.
</div>

<div id="debug-panel">
    -- DEBUG INFO --<br>
    POS: X:0.00 Y:0.00 Z:0.00<br>
    STATE: IDLE<br>
    BOOST: OFF
</div>

<div id="inst-modal">
    タップ：移動 / <b>ダブルタップ：BOOST</b><br>
    <small>デバッグパネルでミツハシくんの座標を確認中</small>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.166.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.166.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // --- 基本設定 ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 10, 15);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // --- ライト ---
    const light = new THREE.DirectionalLight(0xffffff, 1.5);
    light.position.set(5, 10, 7.5);
    light.castShadow = true;
    scene.add(light, new THREE.AmbientLight(0xffffff, 0.8));

    // --- 地面 ---
    const grid = new THREE.GridHelper(40, 40, 0x00ffcc, 0x222222);
    scene.add(grid);
    const plane = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ visible: false }));
    plane.rotation.x = -Math.PI / 2;
    scene.add(plane);

    // --- ミツハシくん (GLB Loader) ---
    let mitsuhashi = new THREE.Group();
    let isModelLoaded = false;
    const loader = new GLTFLoader();

    // 実際のパスに合わせて調整してください
    loader.load('./model.glb', 
        (gltf) => {
            mitsuhashi.add(gltf.scene);
            mitsuhashi.traverse(n => { if(n.isMesh) n.castShadow = true; });
            updateLog("Model 'model.glb' loaded successfully.");
            isModelLoaded = true;
        },
        undefined,
        (error) => {
            updateLog("Error: model.glb not found. Using Debug Mesh.");
            // フォールバック用のダミー（ミツハシくん風）
            const dummy = new THREE.Mesh(new THREE.SphereGeometry(0.6, 16, 16), new THREE.MeshStandardMaterial({color: 0xffff00}));
            dummy.position.y = 0.6;
            mitsuhashi.add(dummy);
        }
    );
    scene.add(mitsuhashi);

    // --- ロジック変数 ---
    let targetPos = new THREE.Vector3();
    let isMoving = false;
    let isBoost = false;
    let speed = 0;
    let lastTap = 0;

    const logEl = document.getElementById('dev-log');
    const debugEl = document.getElementById('debug-panel');

    function updateLog(msg) {
        const lines = logEl.innerHTML.split('<br>');
        lines.push(`[LOG] ${msg}`);
        if(lines.length > 7) lines.shift();
        logEl.innerHTML = lines.join('<br>');
    }

    function updateDebugPanel() {
        debugEl.innerHTML = `
            -- DEBUG INFO --<br>
            POS: X:${mitsuhashi.position.x.toFixed(2)} Y:${mitsuhashi.position.y.toFixed(2)} Z:${mitsuhashi.position.z.toFixed(2)}<br>
            STATE: ${isMoving ? (isBoost ? 'BOOSTING' : 'MOVING') : 'IDLE'}<br>
            BOOST: ${isBoost ? 'ON (x3)' : 'OFF'}
        `;
    }

    // --- 入力制御 ---
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    function handleInteraction(x, y) {
        const now = Date.now();
        mouse.x = (x / window.innerWidth) * 2 - 1;
        mouse.y = -(y / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        
        const intersects = raycaster.intersectObject(plane);
        if (intersects.length > 0) {
            targetPos.copy(intersects[0].point);
            isMoving = true;
            if (now - lastTap < 300) {
                isBoost = true;
                speed = 0.3;
                updateLog("Command: DOUBLE_TAP -> BOOST");
            } else {
                isBoost = false;
                speed = 0.1;
                updateLog("Command: TAP -> GOTO");
            }
        }
        lastTap = now;
    }

    window.addEventListener('mousedown', (e) => handleInteraction(e.clientX, e.clientY));
    window.addEventListener('touchstart', (e) => handleInteraction(e.touches[0].clientX, e.touches[0].clientY));

    // --- アニメーション ---
    const clock = new THREE.Clock();

    function animate() {
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();

        if (isMoving) {
            const diff = new THREE.Vector3().subVectors(targetPos, mitsuhashi.position);
            const dist = diff.length();
            
            if (dist > 0.2) {
                // 向きの調整
                const lookTarget = new THREE.Vector3(targetPos.x, mitsuhashi.position.y, targetPos.z);
                mitsuhashi.lookAt(lookTarget);
                
                // 移動
                mitsuhashi.position.addScaledVector(diff.normalize(), speed);
                
                // ジャンプアニメーション（ミツハシくんらしさ）
                mitsuhashi.position.y = Math.abs(Math.sin(time * (isBoost ? 15 : 8))) * 0.4;
            } else {
                // おっちょこちょいな急停止（少し揺れる）
                isMoving = false;
                mitsuhashi.position.y = 0;
                updateLog("Target Reached.");
            }
        }

        updateDebugPanel();
        renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>
